<!-- FILE: index.html -->
<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>FieldAR Annotator</title>

<link rel="stylesheet" href="./dist/fab-annotator.css">

<style>
body {
    margin: 0;
    overflow: hidden;
    background: #222;
    color: white;
    font-family: sans-serif;
}
#toolbar {
    position: fixed;
    top: 10px;
    left: 10px;
    z-index: 10000;
    display: flex;
    gap: 10px;
}
#toolbar button, #toolbar input {
    padding: 8px 14px;
    font-size: 16px;
}
#annotatorCanvas {
    position: absolute;
    top: 0;
    left: 0;
}
#debugConsole {
    position: fixed;
    bottom: 0;
    left: 0;
    width: 100%;
    max-height: 200px;
    overflow-y: auto;
    background: #222;
    color: #0f0;
    font-family: monospace;
    font-size: 12px;
    padding: 5px;
    box-sizing: border-box;
}
</style>
</head>
<body>

<div id="toolbar">
    <button id="undoBtn">Undo</button>
    <button id="redoBtn">Redo</button>
    <button id="drawPolyBtn">Draw Polygon</button>
    <input type="file" id="imageLoader" accept="image/*">
    <button id="exportBtn">Export</button>
    <button id="importBtn">Import</button>
    <input type="file" id="importFile" accept="application/json" style="display:none">
</div>

<canvas id="annotatorCanvas"></canvas>
<div id="debugConsole"></div>

<script src="./dist/fab-annotator.js"></script>
<script>
const debugConsole = document.getElementById("debugConsole");
function log(msg){ console.log(msg); debugConsole.innerHTML += `[LOG] ${msg}<br>`; debugConsole.scrollTop = debugConsole.scrollHeight;}
function error(msg){ console.error(msg); debugConsole.innerHTML += `[ERROR] ${msg}<br>`; debugConsole.scrollTop = debugConsole.scrollHeight;}
log("ðŸ–¥ Debug console initialized");

// -------------------- INIT --------------------
let canvas = new fabric.Canvas('annotatorCanvas', {selection:true});
let polygonMode = false;
let pointArray = [], lineArray = [], activeLine, activeShape;
let undoStack = [], redoStack = [];

// Set canvas size
canvas.setHeight(window.innerHeight);
canvas.setWidth(window.innerWidth);

// Load saved overlays
let saved = localStorage.getItem("fieldar_overlays");
if(saved){
    try{
        canvas.loadFromJSON(JSON.parse(saved), canvas.renderAll.bind(canvas));
        log("Restored saved overlays");
    } catch(e){
        error("Failed to load saved overlays");
    }
}

// -------------------- SAVE/UNDO --------------------
function saveState(){
    undoStack.push(JSON.stringify(canvas.toJSON()));
    redoStack = []; // clear redo stack
    localStorage.setItem("fieldar_overlays", JSON.stringify(canvas.toJSON()));
    log("Saved canvas state");
}
canvas.on('object:added', saveState);
canvas.on('object:modified', saveState);
canvas.on('object:removed', saveState);

// Undo/Redo buttons
document.getElementById("undoBtn").onclick = ()=>{
    if(undoStack.length>0){
        redoStack.push(JSON.stringify(canvas.toJSON()));
        let last = undoStack.pop();
        canvas.loadFromJSON(last, canvas.renderAll.bind(canvas));
        log("Undo performed");
    }
};
document.getElementById("redoBtn").onclick = ()=>{
    if(redoStack.length>0){
        undoStack.push(JSON.stringify(canvas.toJSON()));
        let last = redoStack.pop();
        canvas.loadFromJSON(last, canvas.renderAll.bind(canvas));
        log("Redo performed");
    }
};

// -------------------- DRAW POLYGON --------------------
document.getElementById("drawPolyBtn").onclick = ()=>{
    polygonMode = !polygonMode;
    log("Polygon mode: "+polygonMode);
    if(!polygonMode){ // cancel active polygon
        pointArray.forEach(p=>canvas.remove(p));
        lineArray.forEach(l=>canvas.remove(l));
        pointArray=[]; lineArray=[]; activeLine=null; activeShape=null;
    }
};

// Polygon click handler
canvas.on('mouse:down', function(options){
    if(!polygonMode) return;
    const pointer = canvas.getPointer(options.e);
    let circle = new fabric.Circle({
        radius:5, fill:pointArray.length===0?'red':'white',
        left:pointer.x, top:pointer.y, originX:'center', originY:'center', selectable:false
    });
    let points = [pointer.x, pointer.y, pointer.x, pointer.y];
    let line = new fabric.Line(points, {stroke:'#999', strokeWidth:2, selectable:false});
    if(activeShape){
        let pts = activeShape.get('points');
        pts.push({x:pointer.x, y:pointer.y});
        activeShape.set({points:pts});
        canvas.remove(activeShape);
        canvas.add(activeShape);
        canvas.renderAll();
    } else {
        activeShape = new fabric.Polygon([{x:pointer.x, y:pointer.y}], {
            stroke:'#333', strokeWidth:1, fill:'rgba(200,200,200,0.2)', selectable:false
        });
        canvas.add(activeShape);
    }
    pointArray.push(circle);
    lineArray.push(line);
    canvas.add(circle);
    canvas.add(line);
});

// Complete polygon on clicking first point
canvas.on('mouse:dblclick', function(){
    if(!polygonMode || pointArray.length<3) return;
    const points = pointArray.map(p=>({x:p.left, y:p.top}));
    pointArray.forEach(p=>canvas.remove(p));
    lineArray.forEach(l=>canvas.remove(l));
    canvas.remove(activeShape);
    const polygon = new fabric.Polygon(points,{
        stroke:'#333', strokeWidth:1, fill:'rgba(0,0,0,0.2)'
    });
    const text = new fabric.Text('Tap and Type', {left:polygon.left, top:polygon.top, fontSize:12, fill:'white', visible:false});
    const group = new fabric.Group([polygon,text],{left:polygon.left, top:polygon.top});
    canvas.add(group);
    polygonMode=false; pointArray=[]; lineArray=[]; activeShape=null; activeLine=null;
    saveState();
    log("Polygon completed");
});

// -------------------- IMAGE LOAD --------------------
document.getElementById("imageLoader").onchange = function(e){
    let reader = new FileReader();
    reader.onload = function(event){
        fabric.Image.fromURL(event.target.result, function(img){
            img.set({left:0,top:0,selectable:false});
            canvas.setBackgroundImage(img, canvas.renderAll.bind(canvas));
            canvas.setWidth(img.width);
            canvas.setHeight(img.height);
            saveState();
        });
    };
    reader.readAsDataURL(e.target.files[0]);
};

// -------------------- EXPORT/IMPORT --------------------
document.getElementById("exportBtn").onclick = ()=>{
    const json = JSON.stringify(canvas.toJSON());
    const blob = new Blob([json], {type:"application/json"});
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = "fieldar-overlays.json";
    a.click();
    URL.revokeObjectURL(url);
    log("Exported canvas JSON, length:"+json.length);
};

document.getElementById("importBtn").onclick = ()=>{document.getElementById("importFile").click()};
document.getElementById("importFile").onchange = (e)=>{
    const file = e.target.files[0];
    if(!file) return error("No file selected");
    const reader = new FileReader();
    reader.onload = (ev)=>{
        try{
            const data = JSON.parse(ev.target.result);
            canvas.loadFromJSON(data, canvas.renderAll.bind(canvas));
            saveState();
            log("Imported JSON, objects: "+canvas.getObjects().length);
        }catch(err){error("Failed to parse JSON")}
    };
    reader.readAsText(file);
};
</script>
</body>
</html>