<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <title>FieldAR Annotator</title>

    <!-- PWA Manifest -->
    <link rel="manifest" href="manifest.json">

    <!-- iOS PWA Support -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-capable" content="yes">

    <!-- Annotator Styles -->
    <link rel="stylesheet" href="dist/fab-annotator.css">

    <!-- Annotator Script -->
    <script src="dist/fab-annotator.js"></script>

    <!-- Service Worker -->
    <script>
      if ('serviceWorker' in navigator) {
        navigator.serviceWorker.register('service-worker.js')
          .then(() => console.log("SW registered"))
          .catch(err => console.error("SW error:", err));
      }
    </script>

    <style>
        body {
            margin: 0;
            padding: 0;
            background: #fafafa;
            font-family: Arial, sans-serif;
            text-align: center;
        }
        #main-container {
            margin: 10px auto;
            max-width: 95vw;
        }
        #main-image {
            max-width: 95vw;
            border: 1px solid #ccc;
        }
    </style>
</head>

<body>

    <div id="main-container">
        <h2>FieldAR Annotator</h2>

        <!-- Base image -->
        <img id="main-image" src="icons/Blue_GCPA-removebg-preview.png" alt="Base Image">
    </div>

    <!-- Annotation + Save/Load Logic -->
    <script>
        const STORAGE_KEY = "fieldar_overlays";

        // Restore overlays if saved previously
        function loadSavedOverlays() {
            const saved = localStorage.getItem(STORAGE_KEY);
            if (!saved) return null;

            try {
                return JSON.parse(saved);
            } catch (err) {
                console.error("Error parsing saved overlays:", err);
                return null;
            }
        }

        // Auto-save overlays to localStorage
        function autoSave(canvas) {
            const data = canvas.toJSON();
            localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
            console.log("Overlays saved.");
        }

        window.onload = function () {
            const img = document.getElementById("main-image");

            img.onload = function () {
                console.log("Image loaded → starting annotator");

                const saved = loadSavedOverlays();

                // Initialize annotator
                const canvas = annoFabric.initCanvas("#main-image", {
                    annotationTextField:
                        "<select class='form-control' name='annotation-text-field'>" +
                            "<option value='Tag 1'>Tag 1</option>" +
                            "<option value='Tag 2'>Tag 2</option>" +
                            "<option value='Tag 3'>Tag 3</option>" +
                        "</select>",
                    canvasHeight: img.clientHeight,
                    canvasWidth: img.clientWidth
                });

                // If previous overlays exist → restore them
                if (saved) {
                    console.log("Restoring saved overlays...");
                    canvas.loadFromJSON(saved, () => {
                        canvas.renderAll();
                    });
                }

                // Auto-save whenever user changes the canvas
                canvas.on("object:added", () => autoSave(canvas));
                canvas.on("object:modified", () => autoSave(canvas));
                canvas.on("object:removed", () => autoSave(canvas));
            };
        };
    </script>

</body>
</html>